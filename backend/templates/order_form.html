{% extends "base.html" %}

{% block title %}Adicionar Pedido{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
  <h2 class="text-2xl font-bold mb-6">Adicionar Pedido</h2>

  <form method="post" id="order-form" class="space-y-6">
    {% csrf_token %}

    <!-- Cliente (opcional) -->
    <div>
      <label for="customer" class="block text-sm font-medium text-gray-700">Cliente (opcional)</label>
      <select name="customer" id="customer"
        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm
               focus:ring-blue-500 focus:border-blue-500 px-3 py-2 bg-white">
        <option value="" selected>-- Nenhum cliente --</option>
        {% for cust in customers %}
          <option value="{{ cust.id }}">{{ cust.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Itens do pedido -->
    <fieldset class="border border-gray-300 rounded-md p-4">
      <legend class="text-lg font-semibold mb-4">Itens do Pedido</legend>

      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th class="p-2 border border-gray-300">Produto</th>
            <th class="p-2 border border-gray-300 w-24">Quantidade</th>
            <th class="p-2 border border-gray-300 w-32">Preço Unitário (R$)</th>
            <th class="p-2 border border-gray-300 w-24">Desconto (R$)</th>
            <th class="p-2 border border-gray-300 w-12"></th>
          </tr>
        </thead>
        <tbody id="order-items-body">
          <!-- Linha modelo do item -->
          <tr class="order-item-row">
            <td class="p-1 border border-gray-300">
              <select name="product" class="product-select block w-full rounded border border-gray-300 p-1"
                required>
                <option value="" selected disabled>Selecione</option>
                {% for product in products %}
                  <option value="{{ product.id }}" data-price="{{ product.sale_price }}">{{ product.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td class="p-1 border border-gray-300">
              <input type="number" name="quantity" class="quantity-input block w-full rounded border border-gray-300 p-1"
                min="1" value="1" required />
            </td>
            <td class="p-1 border border-gray-300">
              <input type="number" name="unit_price" class="unit-price-input block w-full rounded border border-gray-300 p-1"
                step="0.01" min="0" required readonly />
            </td>
            <td class="p-1 border border-gray-300">
              <input type="number" name="discount" class="discount-input block w-full rounded border border-gray-300 p-1"
                step="0.01" min="0" value="0" required />
            </td>
            <td class="p-1 border border-gray-300 text-center">
              <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
            </td>
          </tr>
        </tbody>
      </table>

      <button type="button" id="add-item-btn"
        class="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
        + Adicionar Item
      </button>
    </fieldset>

    <!-- Valor total (readonly) -->
    <div>
      <label for="total_value" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
      <input type="text" id="total_value_display" readonly
        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 bg-gray-100 cursor-not-allowed" />
      <input type="hidden" name="total_value" id="total_value" value="0" />
    </div>

    <button type="submit"
      class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 transition text-lg font-semibold">
      Salvar Pedido
    </button>
  </form>
</div>

<script>
// JS para gerenciar itens do pedido e calcular total
document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.getElementById('order-items-body');
  const addItemBtn = document.getElementById('add-item-btn');
  const totalValueInput = document.getElementById('total_value');
  const totalValueDisplay = document.getElementById('total_value_display');

  function calculateTotal() {
    let total = 0;
    tbody.querySelectorAll('tr').forEach(row => {
      const qty = parseFloat(row.querySelector('.quantity-input').value) || 0;
      const price = parseFloat(row.querySelector('.unit-price-input').value) || 0;
      const discount = parseFloat(row.querySelector('.discount-input').value) || 0;
      let lineTotal = qty * price - discount;
      if(lineTotal < 0) lineTotal = 0;
      total += lineTotal;
    });
    totalValueInput.value = total.toFixed(2);
    totalValueDisplay.value = total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  }

  function updateUnitPrice(select) {
    const row = select.closest('tr');
    const selectedOption = select.selectedOptions[0];
    const priceInput = row.querySelector('.unit-price-input');
    if (selectedOption && selectedOption.dataset.price) {
      priceInput.value = parseFloat(selectedOption.dataset.price).toFixed(2);
    } else {
      priceInput.value = "0.00";
    }
    calculateTotal();
  }

  function addRow() {
    const newRow = tbody.querySelector('tr').cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => {
      if(input.type === 'number'){
        input.value = input.classList.contains('quantity-input') ? "1" : "0";
      } else {
        input.value = "";
      }
    });
    newRow.querySelector('select').value = "";
    tbody.appendChild(newRow);
    attachEvents(newRow);
    calculateTotal();
  }

  function removeRow(button) {
    if (tbody.querySelectorAll('tr').length > 1) {
      button.closest('tr').remove();
      calculateTotal();
    } else {
      alert("O pedido deve conter ao menos um item.");
    }
  }

  function attachEvents(row) {
    const productSelect = row.querySelector('.product-select');
    const qtyInput = row.querySelector('.quantity-input');
    const discountInput = row.querySelector('.discount-input');
    const removeBtn = row.querySelector('.remove-item-btn');

    productSelect.addEventListener('change', () => {
      updateUnitPrice(productSelect);
    });

    qtyInput.addEventListener('input', calculateTotal);
    discountInput.addEventListener('input', calculateTotal);
    removeBtn.addEventListener('click', () => removeRow(removeBtn));
  }

  // Attach events to initial row
  attachEvents(tbody.querySelector('tr'));

  addItemBtn.addEventListener('click', addRow);
});
</script>
{% endblock %}
